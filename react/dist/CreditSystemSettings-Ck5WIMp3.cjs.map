{"version":3,"file":"CreditSystemSettings-Ck5WIMp3.cjs","sources":["../src/components/admin/settings/CreditSystemSettings.tsx"],"sourcesContent":["/**\n * Credit System settings page - deposits, withdrawals, privacy period (with tabs)\n */\nimport { useState, useCallback, useEffect, useMemo } from 'react';\nimport type { SystemSetting } from '../../../types';\nimport { LoadingSpinner } from '../../shared/LoadingSpinner';\nimport { ErrorMessage } from '../../shared/ErrorMessage';\nimport { useSettingsAutosave } from '../../../hooks/useSettingsAutosave';\nimport { SettingsSection } from './settingsInputs';\nimport { AutosaveStatus } from './AutosaveStatus';\n\ntype CreditTab = 'deposits' | 'tokens' | 'fees' | 'privacy' | 'treasury';\n\ninterface TabSection {\n  title: string;\n  description?: string;\n  keys: string[];\n}\n\ninterface TabConfig {\n  id: CreditTab;\n  label: string;\n  /** Categories to pull settings from */\n  categories: string[];\n  /** Specific keys to include (if empty, include all from categories) */\n  includeKeys?: string[];\n  /** Specific keys to exclude */\n  excludeKeys?: string[];\n  /** Additional sections rendered below the main settings */\n  sections?: TabSection[];\n}\n\nconst TABS: TabConfig[] = [\n  {\n    id: 'deposits',\n    label: 'Deposits',\n    categories: ['deposit.general'],\n    includeKeys: [\n      'deposit_company_token',\n      'deposit_max_usd',\n      'deposit_min_usd',\n      'deposit_micro_enabled',\n      'deposit_gasless_swap_enabled',\n      'solana_rpc_url',\n      'jupiter_api_key',\n    ],\n  },\n  {\n    id: 'tokens',\n    label: 'Component',\n    categories: ['deposit'],\n    includeKeys: [\n      'deposit_show_explainer',\n      'deposit_quick_action_tokens',\n      'deposit_custom_tokens',\n      'deposit_custom_tokens_json',\n    ],\n  },\n  {\n    id: 'fees',\n    label: 'Fees',\n    categories: ['deposit'],\n    includeKeys: [\n      'deposit_fee_policy',\n      'privacy_fee_fixed_lamports',\n      'privacy_fee_percent_bps',\n      'swap_fee_fixed_lamports',\n      'swap_fee_percent_bps',\n      'company_fee_fixed_lamports',\n      'company_fee_percent_bps',\n      'private_deposit_min_lamports',\n    ],\n  },\n  {\n    id: 'privacy',\n    label: 'Privacy',\n    categories: ['deposit.general', 'privacy', 'withdrawal'],\n    includeKeys: [\n      // Enable toggle\n      'deposit_privacy_enabled',\n      // Privacy period setting\n      'privacy_period_secs',\n      // Withdrawal settings (from privacy pool)\n      'withdrawal_percentage',\n      'withdrawal_min_lamports',\n      // Partial withdrawal settings (related to privacy mixing)\n      'partial_withdrawal_count',\n      'partial_withdrawal_min_lamports',\n    ],\n    sections: [\n      {\n        title: 'Privacy Pool Worker',\n        description: 'Background worker for processing withdrawals from the privacy cash pool.',\n        keys: ['withdrawal_poll_interval_secs', 'withdrawal_batch_size'],\n      },\n    ],\n  },\n  {\n    id: 'treasury',\n    label: 'Treasury',\n    categories: ['withdrawal', 'deposit'],\n    includeKeys: [\n      // Treasury wallet (separate section)\n      'treasury_wallet_address',\n    ],\n    sections: [\n      {\n        title: 'Micropayment Batch Worker',\n        description: 'Background worker for batching small SOL deposits together.',\n        keys: ['micro_batch_threshold_usd', 'micro_batch_poll_secs'],\n      },\n    ],\n  },\n];\n\nexport interface CreditSystemSettingsProps {\n  className?: string;\n}\n\nexport function CreditSystemSettings({ className }: CreditSystemSettingsProps) {\n  const {\n    settings,\n    edits,\n    isLoading,\n    autosaveStatus,\n    autosaveError,\n    error,\n    fetchSettings,\n    handleChange,\n    getEffectiveValue,\n  } = useSettingsAutosave();\n\n  const [activeTab, setActiveTab] = useState<CreditTab>('deposits');\n\n  useEffect(() => {\n    fetchSettings();\n  }, [fetchSettings]);\n\n  // Get current tab config and filter settings\n  const currentTab = TABS.find((t) => t.id === activeTab);\n\n  // Collect all settings from the tab's categories\n  const allTabSettings = useMemo(() => {\n    if (!currentTab) return [];\n    const allSettings: SystemSetting[] = [];\n    for (const category of currentTab.categories) {\n      const categorySettings = settings[category] ?? [];\n      allSettings.push(...categorySettings);\n    }\n    return allSettings;\n  }, [settings, currentTab]);\n\n  // Get fee policy for conditional visibility\n  const feePolicy = getEffectiveValue('deposit_fee_policy') || 'company_pays_all';\n\n  const currentSettings = useMemo(() => {\n    if (!currentTab) return [];\n\n    // Apply include/exclude filters\n    let filtered = allTabSettings;\n\n    if (currentTab.includeKeys && currentTab.includeKeys.length > 0) {\n      // Only include specific keys\n      filtered = filtered.filter((s) => currentTab.includeKeys!.includes(s.key));\n      // Sort by includeKeys order\n      filtered.sort(\n        (a, b) => currentTab.includeKeys!.indexOf(a.key) - currentTab.includeKeys!.indexOf(b.key)\n      );\n    } else if (currentTab.excludeKeys && currentTab.excludeKeys.length > 0) {\n      // Exclude specific keys\n      filtered = filtered.filter((s) => !currentTab.excludeKeys!.includes(s.key));\n    }\n\n    // Deposits tab: hide SOL micro payments if minimum > $10\n    if (currentTab.id === 'deposits') {\n      const minUsd = parseFloat(getEffectiveValue('deposit_min_usd')) || 0;\n      if (minUsd > 10) {\n        filtered = filtered.filter((s) => s.key !== 'deposit_micro_enabled');\n      }\n    }\n\n    // Fees tab: conditionally show fee settings based on policy\n    if (currentTab.id === 'fees') {\n      const privacyFeeKeys = [\n        'privacy_fee_fixed_lamports',\n        'privacy_fee_percent_bps',\n        'private_deposit_min_lamports',\n      ];\n      const swapFeeKeys = ['swap_fee_fixed_lamports', 'swap_fee_percent_bps'];\n      const companyFeeKeys = ['company_fee_fixed_lamports', 'company_fee_percent_bps'];\n\n      filtered = filtered.filter((s) => {\n        // Always show fee policy selector\n        if (s.key === 'deposit_fee_policy') return true;\n\n        // Hide all fees if company pays all\n        if (feePolicy === 'company_pays_all') return false;\n\n        // Show privacy fees for user_pays_privacy or user_pays_all\n        if (privacyFeeKeys.includes(s.key)) {\n          return feePolicy === 'user_pays_privacy' || feePolicy === 'user_pays_all';\n        }\n\n        // Show swap fees for user_pays_swap or user_pays_all\n        if (swapFeeKeys.includes(s.key)) {\n          return feePolicy === 'user_pays_swap' || feePolicy === 'user_pays_all';\n        }\n\n        // Show company fees only for user_pays_all\n        if (companyFeeKeys.includes(s.key)) {\n          return feePolicy === 'user_pays_all';\n        }\n\n        return true;\n      });\n    }\n\n    return filtered;\n  }, [allTabSettings, currentTab, getEffectiveValue, feePolicy]);\n\n  // Helper to get settings for a section\n  const getSectionSettings = useCallback(\n    (keys: string[]) => {\n      return allTabSettings\n        .filter((s) => keys.includes(s.key))\n        .sort((a, b) => keys.indexOf(a.key) - keys.indexOf(b.key));\n    },\n    [allTabSettings]\n  );\n\n  // Compute external warnings for the deposits tab\n  const externalWarnings = useMemo(() => {\n    if (currentTab?.id !== 'deposits') return undefined;\n\n    const warnings: Record<string, string> = {};\n    const minUsd = parseFloat(getEffectiveValue('deposit_min_usd')) || 0;\n    const microEnabled = getEffectiveValue('deposit_micro_enabled');\n    const isMicroDisabled = microEnabled === 'false' || microEnabled === '0' || microEnabled === '';\n\n    // Warn if micro payments disabled but minimum < $10\n    if (isMicroDisabled && minUsd < 10) {\n      warnings['deposit_min_usd'] =\n        'SOL micro payments must be enabled for minimum deposits under $10.';\n    }\n\n    return Object.keys(warnings).length > 0 ? warnings : undefined;\n  }, [currentTab?.id, getEffectiveValue]);\n\n  // Credit system master toggle\n  const creditsEnabled = getEffectiveValue('feature_credits') === 'true';\n  const handleCreditsToggle = () => {\n    handleChange('feature_credits', creditsEnabled ? 'false' : 'true');\n  };\n\n  if (isLoading && Object.keys(settings).length === 0) {\n    return (\n      <div className={`cedros-system-settings cedros-system-settings-loading ${className ?? ''}`}>\n        <LoadingSpinner />\n        <span>Loading settings...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className={`cedros-system-settings ${className ?? ''}`}>\n        <ErrorMessage error={error.message} />\n      </div>\n    );\n  }\n\n  return (\n    <div className={`cedros-system-settings ${className ?? ''}`}>\n      <div className=\"cedros-settings-page-header\">\n        <div className=\"cedros-settings-page-header-content\">\n          <h2 className=\"cedros-settings-page-title\">Credit System</h2>\n          <p className=\"cedros-settings-page-description\">\n            Configure credit deposits, timed withdrawals, and privacy period settings.\n          </p>\n        </div>\n        <div className=\"cedros-settings-page-header-actions\">\n          <button\n            type=\"button\"\n            role=\"switch\"\n            aria-checked={creditsEnabled}\n            className={`cedros-toggle ${creditsEnabled ? 'cedros-toggle-on' : 'cedros-toggle-off'}`}\n            onClick={handleCreditsToggle}\n          >\n            <span className=\"cedros-toggle-track\">\n              <span className=\"cedros-toggle-thumb\" />\n            </span>\n            <span className=\"cedros-toggle-label\">{creditsEnabled ? 'Enabled' : 'Disabled'}</span>\n          </button>\n          <AutosaveStatus status={autosaveStatus} error={autosaveError} />\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div className=\"cedros-admin-tabs cedros-admin-tabs--line\">\n        {TABS.map((tab) => (\n          <button\n            key={tab.id}\n            type=\"button\"\n            className={`cedros-admin-tab ${activeTab === tab.id ? 'cedros-admin-tab-active' : ''}`}\n            onClick={() => setActiveTab(tab.id)}\n            aria-selected={activeTab === tab.id}\n            role=\"tab\"\n          >\n            {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Tab content */}\n      <div className=\"cedros-admin-tab-content\" role=\"tabpanel\">\n        {currentSettings.length === 0 && !currentTab?.sections?.length ? (\n          <div className=\"cedros-system-settings-empty\">\n            <p>No settings found for {currentTab?.label ?? 'this section'}.</p>\n          </div>\n        ) : (\n          <>\n            {currentSettings.length > 0 && (\n              <SettingsSection\n                settings={currentSettings}\n                edits={edits}\n                onChange={handleChange}\n                externalWarnings={externalWarnings}\n              />\n            )}\n            {/* Render additional sections */}\n            {currentTab?.sections?.map((section) => {\n              const sectionSettings = getSectionSettings(section.keys);\n              if (sectionSettings.length === 0) return null;\n              return (\n                <div key={section.title} className=\"cedros-settings-subsection\">\n                  <div className=\"cedros-settings-subsection-header\">\n                    <h4 className=\"cedros-settings-subsection-title\">{section.title}</h4>\n                    {section.description && (\n                      <p className=\"cedros-settings-subsection-description\">\n                        {section.description}\n                      </p>\n                    )}\n                  </div>\n                  <SettingsSection\n                    settings={sectionSettings}\n                    edits={edits}\n                    onChange={handleChange}\n                  />\n                </div>\n              );\n            })}\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Keep old export name for backwards compatibility\nexport { CreditSystemSettings as PrivacyCashSettings };\nexport type { CreditSystemSettingsProps as PrivacyCashSettingsProps };\n"],"names":["TABS","CreditSystemSettings","className","settings","edits","isLoading","autosaveStatus","autosaveError","error","fetchSettings","handleChange","getEffectiveValue","useSettingsAutosave","activeTab","setActiveTab","useState","useEffect","currentTab","t","allTabSettings","useMemo","allSettings","category","categorySettings","feePolicy","currentSettings","filtered","s","a","b","privacyFeeKeys","swapFeeKeys","companyFeeKeys","getSectionSettings","useCallback","keys","externalWarnings","warnings","minUsd","microEnabled","creditsEnabled","handleCreditsToggle","jsx","LoadingSpinner","ErrorMessage","jsxs","AutosaveStatus","tab","Fragment","SettingsSection","section","sectionSettings"],"mappings":"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"}