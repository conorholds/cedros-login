{"version":3,"file":"useOrgs-CVbacmaQ.cjs","sources":["../src/utils/orgApi.ts","../src/hooks/useOrgs.ts"],"sourcesContent":["import type {\n  Organization,\n  OrgWithMembership,\n  CreateOrgRequest,\n  UpdateOrgRequest,\n  ListOrgsResponse,\n  AuthorizeRequest,\n  AuthorizeResponse,\n  PermissionsResponse,\n} from '../types';\nimport { ApiClient, handleApiError } from './apiClient';\n\n/**\n * API client for organization operations\n */\nexport class OrgApiClient {\n  private client: ApiClient;\n\n  constructor(\n    baseUrl: string,\n    timeoutMs?: number,\n    retryAttempts?: number,\n    getAccessToken?: () => string | null\n  ) {\n    this.client = new ApiClient({ baseUrl, timeoutMs, retryAttempts, getAccessToken });\n  }\n\n  /**\n   * List all organizations the current user belongs to\n   */\n  async listOrgs(): Promise<OrgWithMembership[]> {\n    try {\n      const response = await this.client.get<ListOrgsResponse>('/orgs');\n      return response.orgs.map((org) => ({\n        ...org,\n        membership: {\n          orgId: org.id,\n          role: org.role,\n        },\n      }));\n    } catch (error) {\n      throw handleApiError(error, 'Failed to list organizations');\n    }\n  }\n\n  /**\n   * Get a single organization by ID\n   */\n  async getOrg(orgId: string): Promise<Organization> {\n    try {\n      return await this.client.get<Organization>(`/orgs/${orgId}`);\n    } catch (error) {\n      throw handleApiError(error, 'Failed to get organization');\n    }\n  }\n\n  /**\n   * Create a new organization\n   */\n  async createOrg(data: CreateOrgRequest): Promise<Organization> {\n    try {\n      return await this.client.post<Organization>('/orgs', data);\n    } catch (error) {\n      throw handleApiError(error, 'Failed to create organization');\n    }\n  }\n\n  /**\n   * Update an organization\n   */\n  async updateOrg(orgId: string, data: UpdateOrgRequest): Promise<Organization> {\n    try {\n      return await this.client.patch<Organization>(`/orgs/${orgId}`, data);\n    } catch (error) {\n      throw handleApiError(error, 'Failed to update organization');\n    }\n  }\n\n  /**\n   * Delete an organization\n   */\n  async deleteOrg(orgId: string): Promise<void> {\n    try {\n      await this.client.delete<void>(`/orgs/${orgId}`);\n    } catch (error) {\n      throw handleApiError(error, 'Failed to delete organization');\n    }\n  }\n\n  /**\n   * Check authorization for an action\n   */\n  async authorize(data: AuthorizeRequest): Promise<AuthorizeResponse> {\n    try {\n      return await this.client.post<AuthorizeResponse>('/authorize', data);\n    } catch (error) {\n      throw handleApiError(error, 'Failed to check authorization');\n    }\n  }\n\n  /**\n   * Get current user's permissions in an organization\n   */\n  async getPermissions(orgId: string): Promise<PermissionsResponse> {\n    try {\n      return await this.client.post<PermissionsResponse>('/permissions', { orgId });\n    } catch (error) {\n      throw handleApiError(error, 'Failed to get permissions');\n    }\n  }\n}\n","import { useState, useCallback, useMemo, useRef, useEffect } from 'react';\nimport type {\n  OrgWithMembership,\n  Organization,\n  CreateOrgRequest,\n  UpdateOrgRequest,\n  Permission,\n  OrgRole,\n  AuthError,\n} from '../types';\nimport { useCedrosLogin } from '../context/useCedrosLogin';\nimport { OrgApiClient } from '../utils/orgApi';\n\nexport interface UseOrgsReturn {\n  /** All organizations the user belongs to */\n  orgs: OrgWithMembership[];\n  /** Currently active organization */\n  activeOrg: OrgWithMembership | null;\n  /** User's permissions in the active org */\n  permissions: Permission[];\n  /** User's role in the active org */\n  role: OrgRole | null;\n  /** Loading state */\n  isLoading: boolean;\n  /** Error state */\n  error: AuthError | null;\n  /** Fetch/refresh organizations list */\n  fetchOrgs: () => Promise<void>;\n  /** Switch to a different organization */\n  switchOrg: (orgId: string) => Promise<void>;\n  /** Create a new organization */\n  createOrg: (data: CreateOrgRequest) => Promise<Organization>;\n  /** Update an organization */\n  updateOrg: (orgId: string, data: UpdateOrgRequest) => Promise<Organization>;\n  /** Delete an organization */\n  deleteOrg: (orgId: string) => Promise<void>;\n  /** Check if user has a specific permission */\n  hasPermission: (permission: Permission) => boolean;\n}\n\nconst ACTIVE_ORG_KEY = 'cedros_active_org';\n\n// P-06: Safe localStorage helpers to handle private browsing and quota errors\nfunction safeGetItem(key: string): string | null {\n  try {\n    return localStorage.getItem(key);\n  } catch {\n    return null;\n  }\n}\n\nfunction safeSetItem(key: string, value: string): void {\n  try {\n    localStorage.setItem(key, value);\n  } catch {\n    // Ignore - private browsing or quota exceeded\n  }\n}\n\n/**\n * Hook for managing organizations, memberships, and permissions.\n *\n * @example\n * ```tsx\n * function OrgSelector() {\n *   const { orgs, activeOrg, switchOrg, hasPermission } = useOrgs();\n *\n *   return (\n *     <select\n *       value={activeOrg?.id}\n *       onChange={(e) => switchOrg(e.target.value)}\n *     >\n *       {orgs.map(org => (\n *         <option key={org.id} value={org.id}>{org.name}</option>\n *       ))}\n *     </select>\n *   );\n * }\n * ```\n */\nexport function useOrgs(): UseOrgsReturn {\n  const { config, user, authState, _internal } = useCedrosLogin();\n  const hasStorage = typeof window !== 'undefined' && !!window.localStorage;\n\n  const [orgs, setOrgs] = useState<OrgWithMembership[]>([]);\n  const [activeOrg, setActiveOrg] = useState<OrgWithMembership | null>(null);\n  const [permissions, setPermissions] = useState<Permission[]>([]);\n  const [role, setRole] = useState<OrgRole | null>(null);\n  const [isLoading, setIsLoading] = useState(authState === 'authenticated');\n  const [error, setError] = useState<AuthError | null>(null);\n\n  // M-03: Memoize API client and use ref to prevent callback dependency cascades\n  const apiClient = useMemo(\n    () =>\n      new OrgApiClient(\n        config.serverUrl,\n        config.requestTimeout,\n        config.retryAttempts,\n        _internal?.getAccessToken\n      ),\n    [config.serverUrl, config.requestTimeout, config.retryAttempts, _internal]\n  );\n\n  // M-03: Store apiClient in ref to stabilize callback dependencies\n  const apiClientRef = useRef(apiClient);\n  useEffect(() => {\n    apiClientRef.current = apiClient;\n  }, [apiClient]);\n\n  // M-03: Use ref in callback to break dependency chain\n  const loadPermissions = useCallback(async (orgId: string) => {\n    try {\n      const response = await apiClientRef.current.getPermissions(orgId);\n      setPermissions(response.permissions);\n      setRole(response.role);\n    } catch {\n      // Permissions loading failure is non-fatal, just clear them\n      setPermissions([]);\n      setRole(null);\n    }\n  }, []);\n\n  // Ref to latest fetchOrgs for stable auto-fetch effect\n  const fetchOrgsRef = useRef<() => Promise<void>>(async () => {});\n\n  // M-03: Use ref to break apiClient dependency chain\n  const fetchOrgs = useCallback(async () => {\n    if (authState !== 'authenticated' || !user) {\n      setOrgs([]);\n      setActiveOrg(null);\n      setPermissions([]);\n      setRole(null);\n      return;\n    }\n\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const fetchedOrgs = await apiClientRef.current.listOrgs();\n      setOrgs(fetchedOrgs);\n\n      // P-06: Restore active org from localStorage with safe access\n      const savedOrgId = hasStorage ? safeGetItem(ACTIVE_ORG_KEY) : null;\n      let selectedOrg = fetchedOrgs.find((org) => org.id === savedOrgId);\n\n      if (!selectedOrg && fetchedOrgs.length > 0) {\n        // Default to personal org or first org\n        selectedOrg = fetchedOrgs.find((org) => org.isPersonal) || fetchedOrgs[0];\n      }\n\n      if (selectedOrg) {\n        setActiveOrg(selectedOrg);\n        if (hasStorage) {\n          safeSetItem(ACTIVE_ORG_KEY, selectedOrg.id);\n        }\n        await loadPermissions(selectedOrg.id);\n      } else {\n        setActiveOrg(null);\n        setPermissions([]);\n        setRole(null);\n      }\n    } catch (err) {\n      setError(err as AuthError);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [authState, user, loadPermissions, hasStorage]);\n\n  // Keep fetchOrgsRef current so auto-fetch always calls the latest version\n  useEffect(() => {\n    fetchOrgsRef.current = fetchOrgs;\n  }, [fetchOrgs]);\n\n  // Auto-fetch orgs when auth becomes ready.\n  // Uses only `authState` (a string) as dep â€” immune to object-identity churn\n  // from the AdminShell bridge recreating `user` objects.\n  const hasAutoFetched = useRef(false);\n  useEffect(() => {\n    if (authState === 'authenticated' && !hasAutoFetched.current) {\n      hasAutoFetched.current = true;\n      fetchOrgsRef.current();\n    } else if (authState !== 'authenticated') {\n      hasAutoFetched.current = false;\n    }\n  }, [authState]);\n\n  const switchOrg = useCallback(\n    async (orgId: string) => {\n      const org = orgs.find((o) => o.id === orgId);\n      if (!org) {\n        setError({ code: 'UNKNOWN_ERROR', message: 'Organization not found' });\n        return;\n      }\n\n      setActiveOrg(org);\n      if (hasStorage) {\n        safeSetItem(ACTIVE_ORG_KEY, orgId);\n      }\n      await loadPermissions(orgId);\n    },\n    [orgs, loadPermissions, hasStorage]\n  );\n\n  // M-03: Use ref to break apiClient dependency chain\n  const createOrg = useCallback(\n    async (data: CreateOrgRequest): Promise<Organization> => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        const newOrg = await apiClientRef.current.createOrg(data);\n        // Refresh orgs list to include the new org with membership\n        await fetchOrgs();\n        return newOrg;\n      } catch (err) {\n        setError(err as AuthError);\n        throw err;\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [fetchOrgs]\n  );\n\n  const updateOrg = useCallback(\n    async (orgId: string, data: UpdateOrgRequest): Promise<Organization> => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        const updatedOrg = await apiClientRef.current.updateOrg(orgId, data);\n        // Refresh orgs list to reflect changes\n        await fetchOrgs();\n        return updatedOrg;\n      } catch (err) {\n        setError(err as AuthError);\n        throw err;\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [fetchOrgs]\n  );\n\n  const deleteOrg = useCallback(\n    async (orgId: string): Promise<void> => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        await apiClientRef.current.deleteOrg(orgId);\n        // Refresh orgs list\n        await fetchOrgs();\n      } catch (err) {\n        setError(err as AuthError);\n        throw err;\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [fetchOrgs]\n  );\n\n  const hasPermission = useCallback(\n    (permission: Permission): boolean => {\n      return permissions.includes(permission);\n    },\n    [permissions]\n  );\n\n  return {\n    orgs,\n    activeOrg,\n    permissions,\n    role,\n    isLoading,\n    error,\n    fetchOrgs,\n    switchOrg,\n    createOrg,\n    updateOrg,\n    deleteOrg,\n    hasPermission,\n  };\n}\n"],"names":["OrgApiClient","baseUrl","timeoutMs","retryAttempts","getAccessToken","ApiClient","org","error","handleApiError","orgId","data","ACTIVE_ORG_KEY","safeGetItem","key","safeSetItem","value","useOrgs","config","user","authState","_internal","useCedrosLogin","hasStorage","orgs","setOrgs","useState","activeOrg","setActiveOrg","permissions","setPermissions","role","setRole","isLoading","setIsLoading","setError","apiClient","useMemo","apiClientRef","useRef","useEffect","loadPermissions","useCallback","response","fetchOrgsRef","fetchOrgs","fetchedOrgs","savedOrgId","selectedOrg","err","hasAutoFetched","switchOrg","o","createOrg","newOrg","updateOrg","updatedOrg","deleteOrg","hasPermission","permission"],"mappings":"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"}