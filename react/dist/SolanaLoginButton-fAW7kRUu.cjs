"use strict";const t=require("react/jsx-runtime"),l=require("react"),C=require("./apiClient-CTTKhsYb.cjs"),M=require("./validation-BuGQrA-K.cjs"),$=require("./LoadingSpinner-d6sSxgQN.cjs");function B(){const{config:a,_internal:n}=C.useCedrosLogin(),[u,f]=l.useState(!1),[E,r]=l.useState(null),g=l.useMemo(()=>new C.ApiClient({baseUrl:a.serverUrl,timeoutMs:a.requestTimeout,retryAttempts:a.retryAttempts}),[a.serverUrl,a.requestTimeout,a.retryAttempts]),s=l.useCallback(async h=>{if(!M.validateSolanaPublicKey(h)){const c={code:"INVALID_PUBLIC_KEY",message:"Invalid Solana public key format"};throw r(c),c}f(!0),r(null);try{return await g.post("/solana/challenge",{publicKey:h},{credentials:"omit"})}catch(c){const i=C.handleApiError(c,"Failed to get challenge");throw r(i),i}finally{f(!1)}},[g]),w=l.useCallback(async(h,c,i)=>{if(!M.validateSolanaPublicKey(h)){const o={code:"INVALID_PUBLIC_KEY",message:"Invalid Solana public key format"};throw r(o),o}f(!0),r(null);try{const o=await g.post("/solana",{publicKey:h,signature:c,message:i});return a.callbacks?.onLoginSuccess?.(o.user,"solana"),n?.handleLoginSuccess(o.user,o.tokens),o}catch(o){const d=C.handleApiError(o,"Solana sign-in failed");throw r(d),d}finally{f(!1)}},[g,a.callbacks,n]),y=l.useCallback(()=>r(null),[]);return{requestChallenge:s,signIn:w,isLoading:u,error:E,clearError:y}}const D=["phantom","solflare","backpack","glow","slope","sollet","coin98","clover","mathWallet","ledger","torus","walletconnect"];function q(a){if(!a||typeof a!="object")return!1;const n=a;return typeof n.connect=="function"||typeof n.signMessage=="function"||typeof n.signTransaction=="function"||"isConnected"in n}function T(){if(typeof window>"u")return!1;const a=window;for(const n of D){const u=a[n];if(u&&typeof u=="object"&&"solana"in u&&q(u.solana))return!0}return!!q(a.solana)}function F({onSuccess:a,onError:n,className:u="",variant:f="default",size:E="md",disabled:r=!1,hideIfNoWallet:g=!0,walletContext:s}){const{requestChallenge:w,signIn:y,isLoading:h}=B(),[c,i]=l.useState(!1),[o,d]=l.useState(!1),[W,L]=l.useState(!1),j=l.useRef(!1),[U]=l.useState(()=>T()),m=s?.connected??!1,k=s?.connecting??!1,p=s?.publicKey,S=s?.signMessage,x=s?.wallet,b=(s?.wallets??[]).filter(e=>e.adapter.readyState==="Installed"||e.adapter.readyState==="Loadable"),_=s?b.length>0:U,I=l.useCallback(async()=>{if(!j.current){if(!p||!S){n?.(new Error("Wallet not ready"));return}j.current=!0;try{const e=p.toBase58(),v=await w(e),V=new TextEncoder().encode(v.message),N=await S(V);if(!(N instanceof Uint8Array)||N.length===0)throw new Error("Wallet returned invalid signature");let P;try{P=btoa(String.fromCharCode(...N))}catch{throw new Error("Failed to encode signature")}await y(e,P,v.message),a?.()}catch(e){const v=e instanceof Error?e:new Error(String(e));n?.(v)}finally{j.current=!1,d(!1)}}},[p,S,w,y,a,n]);if(l.useEffect(()=>{W&&x&&!m&&!k&&s?.connect&&(L(!1),s.connect().catch(e=>{n?.(e instanceof Error?e:new Error(String(e))),d(!1)}))},[W,x,m,k,s,n]),l.useEffect(()=>{o&&m&&p&&S&&!j.current&&I().catch(()=>{})},[o,m,p,S,I]),g&&!_)return null;const z=async()=>{r||h||k||(m&&p&&S?(d(!0),await I()):x?(d(!0),L(!0)):b.length===1?(s?.select(b[0].adapter.name),d(!0),L(!0)):b.length>1?i(!0):n?.(new Error("No Solana wallet found. Please install Phantom or another Solana wallet.")))},K=e=>{i(!1),s?.select(e),d(!0),L(!0)},R={sm:"cedros-button-sm",md:"cedros-button-md",lg:"cedros-button-lg"},H={default:"cedros-button-solana",outline:"cedros-button-solana-outline"},A=h||k||o&&!m;return t.jsxs(t.Fragment,{children:[t.jsxs("button",{type:"button",className:`cedros-button ${H[f]} ${R[E]} ${u}`,onClick:z,disabled:r||A,"aria-label":"Continue with Solana",children:[A?t.jsx($.LoadingSpinner,{size:"sm"}):t.jsxs("svg",{className:"cedros-button-icon",width:"18",height:"18",viewBox:"0 0 128 128",fill:"currentColor","aria-hidden":"true",children:[t.jsx("path",{d:"M25.38 96.04a4.35 4.35 0 0 1 3.07-1.27h91.68c1.93 0 2.9 2.34 1.54 3.7l-17.71 17.72a4.35 4.35 0 0 1-3.07 1.27H9.21c-1.93 0-2.9-2.34-1.54-3.7l17.71-17.72z"}),t.jsx("path",{d:"M25.38 11.81a4.47 4.47 0 0 1 3.07-1.27h91.68c1.93 0 2.9 2.34 1.54 3.7L103.96 31.96a4.35 4.35 0 0 1-3.07 1.27H9.21c-1.93 0-2.9-2.34-1.54-3.7L25.38 11.81z"}),t.jsx("path",{d:"M102.62 53.76a4.35 4.35 0 0 0-3.07-1.27H7.87c-1.93 0-2.9 2.34-1.54 3.7l17.71 17.72a4.35 4.35 0 0 0 3.07 1.27h91.68c1.93 0 2.9-2.34 1.54-3.7L102.62 53.76z"})]}),t.jsx("span",{children:"Continue with Solana"})]}),c&&t.jsx("div",{className:"cedros-modal-backdrop",onClick:()=>i(!1),role:"presentation",children:t.jsxs("div",{className:"cedros-modal cedros-wallet-selector",role:"dialog","aria-modal":"true","aria-labelledby":"wallet-selector-title",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"cedros-modal-header",children:[t.jsx("h2",{id:"wallet-selector-title",className:"cedros-modal-title",children:"Select Wallet"}),t.jsx("button",{type:"button",className:"cedros-modal-close",onClick:()=>i(!1),"aria-label":"Close",children:t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true",children:t.jsx("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]}),t.jsx("div",{className:"cedros-modal-content",children:t.jsx("div",{className:"cedros-wallet-list",children:b.map(e=>t.jsxs("button",{type:"button",className:"cedros-wallet-option",onClick:()=>K(e.adapter.name),children:[t.jsx("img",{src:e.adapter.icon,alt:"",width:"32",height:"32",className:"cedros-wallet-icon"}),t.jsx("span",{children:e.adapter.name})]},e.adapter.name))})})]})})]})}exports.SolanaLoginButton=F;exports.detectSolanaWallets=T;exports.useSolanaAuth=B;
