"use strict";const e=require("react/jsx-runtime"),o=require("react"),A=require("./LoadingSpinner-d6sSxgQN.cjs"),E=require("./ErrorMessage-CHbYbVi2.cjs"),C=require("./AutosaveStatus-CYkC2aI_.cjs"),D=require("./apiClient-CTTKhsYb.cjs"),$=require("./useOrgs-CVbacmaQ.cjs");function T(){const{config:n,_internal:g}=D.useCedrosLogin(),u=n.serverUrl,f=o.useRef(g?.getAccessToken??(()=>null));f.current=g?.getAccessToken??(()=>null);const[b,S]=o.useState([]),[v,x]=o.useState(0),[k,c]=o.useState(!1),[N,r]=o.useState(null),h=o.useCallback(()=>{const d=f.current();return{"Content-Type":"application/json",...d?{Authorization:`Bearer ${d}`}:{}}},[]),p=o.useCallback(async(d,t=50,a=0)=>{c(!0),r(null);try{const i=new URLSearchParams;d&&i.set("org_id",d),i.set("limit",String(t)),i.set("offset",String(a));const s=await fetch(`${u}/admin/sso-providers?${i}`,{headers:h()});if(!s.ok){const P=await s.json().catch(()=>({}));throw new Error(P.error||`Failed to fetch SSO providers: ${s.status}`)}const j=await s.json();return S(j.providers),x(j.total),j}catch(i){const s=i instanceof Error?i:new Error(String(i));throw r(s),s}finally{c(!1)}},[u,h]),l=o.useCallback(async d=>{c(!0),r(null);try{const t=await fetch(`${u}/admin/sso-providers`,{method:"POST",headers:h(),body:JSON.stringify(d)});if(!t.ok){const i=await t.json().catch(()=>({}));throw new Error(i.error||`Failed to create SSO provider: ${t.status}`)}const a=await t.json();return S(i=>[...i,a]),x(i=>i+1),a}catch(t){const a=t instanceof Error?t:new Error(String(t));throw r(a),a}finally{c(!1)}},[u,h]),m=o.useCallback(async(d,t)=>{c(!0),r(null);try{const a=await fetch(`${u}/admin/sso-providers/${d}`,{method:"PUT",headers:h(),body:JSON.stringify(t)});if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.error||`Failed to update SSO provider: ${a.status}`)}const i=await a.json();return S(s=>s.map(j=>j.id===d?i:j)),i}catch(a){const i=a instanceof Error?a:new Error(String(a));throw r(i),i}finally{c(!1)}},[u,h]),w=o.useCallback(async d=>{c(!0),r(null);try{const t=await fetch(`${u}/admin/sso-providers/${d}`,{method:"DELETE",headers:h()});if(!t.ok){const a=await t.json().catch(()=>({}));throw new Error(a.error||`Failed to delete SSO provider: ${t.status}`)}S(a=>a.filter(i=>i.id!==d)),x(a=>a-1)}catch(t){const a=t instanceof Error?t:new Error(String(t));throw r(a),a}finally{c(!1)}},[u,h]),y=o.useCallback(async(d,t)=>m(d,{enabled:t}),[m]);return{providers:b,total:v,isLoading:k,error:N,fetchProviders:p,createProvider:l,updateProvider:m,deleteProvider:w,toggleProvider:y}}function I({className:n}){const{providers:g,isLoading:u,error:f,fetchProviders:b,createProvider:S,updateProvider:v,deleteProvider:x,toggleProvider:k}=T(),{activeOrg:c}=$.useOrgs(),[N,r]=o.useState("list"),[h,p]=o.useState(null),[l,m]=o.useState(null);o.useEffect(()=>{b(c?.id)},[b,c?.id]);const w=()=>{p(null),m(null),r("add")},y=s=>{p(s),m(null),r("edit")},d=()=>{r("list"),p(null),m(null)},t=async s=>{if(confirm(`Delete SSO provider "${s.name}"? This cannot be undone.`))try{await x(s.id)}catch{}},a=async s=>{try{await k(s.id,!s.enabled)}catch{}},i=async s=>{m(null);try{N==="add"?await S(s):h&&await v(h.id,s),r("list"),p(null)}catch(j){m(j instanceof Error?j.message:"Failed to save provider")}};return u&&g.length===0?e.jsxs("div",{className:`cedros-system-settings cedros-system-settings-loading ${n??""}`,children:[e.jsx(A.LoadingSpinner,{}),e.jsx("span",{children:"Loading SSO providers..."})]}):N==="add"||N==="edit"?e.jsx("div",{className:`cedros-system-settings ${n??""}`,children:e.jsx(F,{provider:h,orgId:c?.id,error:l,isLoading:u,onSave:i,onCancel:d})}):e.jsxs("div",{className:`cedros-system-settings ${n??""}`,children:[e.jsxs("div",{className:"cedros-settings-page-header",children:[e.jsxs("div",{className:"cedros-settings-page-header-content",children:[e.jsx("h2",{className:"cedros-settings-page-title",children:"SSO Providers"}),e.jsx("p",{className:"cedros-settings-page-description",children:"Configure OIDC identity providers for enterprise single sign-on."})]}),e.jsx("button",{type:"button",className:"cedros-btn cedros-btn-primary",onClick:w,children:"Add Provider"})]}),f&&e.jsx(E.ErrorMessage,{error:f.message}),g.length===0?e.jsxs("div",{className:"cedros-system-settings-empty",children:[e.jsx("p",{children:"No SSO providers configured."}),e.jsx("p",{className:"cedros-text-muted",children:"Add an OIDC provider like Okta, Azure AD, or Auth0 to enable enterprise SSO."})]}):e.jsx("div",{className:"cedros-sso-provider-list",children:g.map(s=>e.jsx(L,{provider:s,onEdit:()=>y(s),onDelete:()=>t(s),onToggle:()=>a(s)},s.id))})]})}function L({provider:n,onEdit:g,onDelete:u,onToggle:f}){return e.jsxs("div",{className:`cedros-sso-provider-card ${n.enabled?"":"cedros-sso-provider-card--disabled"}`,children:[e.jsxs("div",{className:"cedros-sso-provider-card-header",children:[e.jsxs("div",{className:"cedros-sso-provider-card-info",children:[e.jsx("h3",{className:"cedros-sso-provider-card-name",children:n.name}),e.jsx("p",{className:"cedros-sso-provider-card-issuer",children:n.issuerUrl})]}),e.jsxs("button",{type:"button",role:"switch","aria-checked":n.enabled,className:`cedros-toggle ${n.enabled?"cedros-toggle-on":"cedros-toggle-off"}`,onClick:f,children:[e.jsx("span",{className:"cedros-toggle-track",children:e.jsx("span",{className:"cedros-toggle-thumb"})}),e.jsx("span",{className:"cedros-toggle-label",children:n.enabled?"Enabled":"Disabled"})]})]}),e.jsxs("div",{className:"cedros-sso-provider-card-details",children:[e.jsxs("div",{className:"cedros-sso-provider-card-detail",children:[e.jsx("span",{className:"cedros-sso-provider-card-detail-label",children:"Client ID"}),e.jsx("code",{className:"cedros-sso-provider-card-detail-value",children:n.clientId})]}),n.emailDomain&&e.jsxs("div",{className:"cedros-sso-provider-card-detail",children:[e.jsx("span",{className:"cedros-sso-provider-card-detail-label",children:"Email Domain"}),e.jsxs("span",{className:"cedros-sso-provider-card-detail-value",children:["@",n.emailDomain]})]}),e.jsxs("div",{className:"cedros-sso-provider-card-detail",children:[e.jsx("span",{className:"cedros-sso-provider-card-detail-label",children:"Registration"}),e.jsx("span",{className:"cedros-sso-provider-card-detail-value",children:n.allowRegistration?"Allowed":"Existing users only"})]})]}),e.jsxs("div",{className:"cedros-sso-provider-card-actions",children:[e.jsx("button",{type:"button",className:"cedros-btn cedros-btn-ghost",onClick:g,children:"Edit"}),e.jsx("button",{type:"button",className:"cedros-btn cedros-btn-ghost cedros-btn-danger",onClick:u,children:"Delete"})]})]})}function F({provider:n,orgId:g,error:u,isLoading:f,onSave:b,onCancel:S}){const v=!!n,[x,k]=o.useState(n?.name??""),[c,N]=o.useState(n?.issuerUrl??""),[r,h]=o.useState(n?.clientId??""),[p,l]=o.useState(""),[m,w]=o.useState(n?.emailDomain??""),[y,d]=o.useState(n?.allowRegistration??!0),[t,a]=o.useState(n?.enabled??!0),i=o.useCallback(s=>{if(s.preventDefault(),v){const j={name:x,issuerUrl:c,clientId:r,emailDomain:m||null,allowRegistration:y,enabled:t};p&&(j.clientSecret=p),b(j)}else{if(!g)return;b({orgId:g,name:x,issuerUrl:c,clientId:r,clientSecret:p,emailDomain:m||null,allowRegistration:y,enabled:t})}},[v,g,x,c,r,p,m,y,t,b]);return e.jsxs("form",{className:"cedros-sso-provider-form",onSubmit:i,children:[e.jsx("div",{className:"cedros-settings-page-header",children:e.jsxs("div",{className:"cedros-settings-page-header-content",children:[e.jsx("h2",{className:"cedros-settings-page-title",children:v?"Edit SSO Provider":"Add SSO Provider"}),e.jsx("p",{className:"cedros-settings-page-description",children:"Configure an OIDC identity provider for enterprise single sign-on."})]})}),u&&e.jsx(E.ErrorMessage,{error:u}),e.jsxs("div",{className:"cedros-form-section",children:[e.jsxs("div",{className:"cedros-form-group",children:[e.jsx("label",{className:"cedros-form-label",htmlFor:"sso-name",children:"Provider Name"}),e.jsx("input",{id:"sso-name",type:"text",className:"cedros-form-input",value:x,onChange:s=>k(s.target.value),placeholder:"e.g., Okta, Azure AD",required:!0})]}),e.jsxs("div",{className:"cedros-form-group",children:[e.jsx("label",{className:"cedros-form-label",htmlFor:"sso-issuer",children:"Issuer URL"}),e.jsx("input",{id:"sso-issuer",type:"url",className:"cedros-form-input",value:c,onChange:s=>N(s.target.value),placeholder:"https://your-org.okta.com",required:!0}),e.jsx("p",{className:"cedros-form-hint",children:"The OIDC issuer URL. Must support discovery at /.well-known/openid-configuration"})]}),e.jsxs("div",{className:"cedros-form-group",children:[e.jsx("label",{className:"cedros-form-label",htmlFor:"sso-client-id",children:"Client ID"}),e.jsx("input",{id:"sso-client-id",type:"text",className:"cedros-form-input",value:r,onChange:s=>h(s.target.value),placeholder:"OAuth client ID",required:!0})]}),e.jsxs("div",{className:"cedros-form-group",children:[e.jsxs("label",{className:"cedros-form-label",htmlFor:"sso-client-secret",children:["Client Secret"," ",v&&e.jsx("span",{className:"cedros-form-hint-inline",children:"(leave blank to keep current)"})]}),e.jsx("input",{id:"sso-client-secret",type:"password",className:"cedros-form-input",value:p,onChange:s=>l(s.target.value),placeholder:v?"••••••••":"OAuth client secret",required:!v})]}),e.jsxs("div",{className:"cedros-form-group",children:[e.jsx("label",{className:"cedros-form-label",htmlFor:"sso-email-domain",children:"Email Domain (optional)"}),e.jsx("input",{id:"sso-email-domain",type:"text",className:"cedros-form-input",value:m,onChange:s=>w(s.target.value),placeholder:"company.com"}),e.jsx("p",{className:"cedros-form-hint",children:"Restrict to users with emails from this domain"})]}),e.jsx("div",{className:"cedros-form-group",children:e.jsxs("label",{className:"cedros-form-checkbox",children:[e.jsx("input",{type:"checkbox",checked:y,onChange:s=>d(s.target.checked)}),e.jsx("span",{children:"Allow new user registration via SSO"})]})}),e.jsx("div",{className:"cedros-form-group",children:e.jsxs("label",{className:"cedros-form-checkbox",children:[e.jsx("input",{type:"checkbox",checked:t,onChange:s=>a(s.target.checked)}),e.jsx("span",{children:"Enable this provider"})]})})]}),e.jsxs("div",{className:"cedros-form-actions",children:[e.jsx("button",{type:"button",className:"cedros-btn cedros-btn-ghost",onClick:S,disabled:f,children:"Cancel"}),e.jsx("button",{type:"submit",className:"cedros-btn cedros-btn-primary",disabled:f,children:f?"Saving...":v?"Save Changes":"Add Provider"})]})]})}const O=[{id:"email",label:"Email",categories:["auth.email"]},{id:"google",label:"Google",categories:["auth.google"]},{id:"apple",label:"Apple",categories:["auth.apple"]},{id:"solana",label:"Solana",categories:["auth.solana"]},{id:"passkeys",label:"Passkeys",categories:["auth.webauthn"]},{id:"instantlink",label:"Instant Link",categories:["auth.instantlink"]},{id:"sso",label:"SSO Providers",categories:[],isCustom:!0}];function R({className:n}){const{settings:g,edits:u,isLoading:f,autosaveStatus:b,autosaveError:S,error:v,fetchSettings:x,handleChange:k}=C.useSettingsAutosave(),[c,N]=o.useState("email");o.useEffect(()=>{x()},[x]);const r=O.find(l=>l.id===c),h=o.useMemo(()=>{if(!r)return[];const l=[];for(const m of r.categories){const w=g[m]??[];l.push(...w)}return l},[g,r]),p=o.useMemo(()=>r?.keys?h.filter(l=>r.keys.includes(l.key)).sort((l,m)=>r.keys.indexOf(l.key)-r.keys.indexOf(m.key)):h,[h,r]);return f&&Object.keys(g).length===0?e.jsxs("div",{className:`cedros-system-settings cedros-system-settings-loading ${n??""}`,children:[e.jsx(A.LoadingSpinner,{}),e.jsx("span",{children:"Loading settings..."})]}):v?e.jsx("div",{className:`cedros-system-settings ${n??""}`,children:e.jsx(E.ErrorMessage,{error:v.message})}):e.jsxs("div",{className:`cedros-system-settings ${n??""}`,children:[e.jsxs("div",{className:"cedros-settings-page-header",children:[e.jsxs("div",{className:"cedros-settings-page-header-content",children:[e.jsx("h2",{className:"cedros-settings-page-title",children:"Authentication"}),e.jsx("p",{className:"cedros-settings-page-description",children:"Configure authentication providers and methods for user sign-in."})]}),e.jsx(C.AutosaveStatus,{status:b,error:S})]}),e.jsx("div",{className:"cedros-admin-tabs cedros-admin-tabs--line",children:O.map(l=>e.jsx("button",{type:"button",className:`cedros-admin-tab ${c===l.id?"cedros-admin-tab-active":""}`,onClick:()=>N(l.id),"aria-selected":c===l.id,role:"tab",children:l.label},l.id))}),e.jsx("div",{className:"cedros-admin-tab-content",role:"tabpanel",children:r?.isCustom?e.jsx(I,{}):p.length===0?e.jsx("div",{className:"cedros-system-settings-empty",children:e.jsxs("p",{children:["No settings found for ",r?.label??"this provider","."]})}):e.jsx(C.SettingsSection,{settings:p,edits:u,onChange:k})})]})}exports.AuthenticationSettings=R;
