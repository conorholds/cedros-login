{"version":3,"file":"ServerSettings-Ch8MCmAY.js","sources":["../src/components/admin/settings/ServerSettings.tsx"],"sourcesContent":["/**\n * Server settings page - infrastructure configuration with tabs\n *\n * Tab visibility:\n * - Integrations: only shown when `feature_cedros_pay` is enabled.\n *   This tab contains the Cedros Pay API Key, which is only needed when\n *   cedros-pay runs as a separate microservice. In co-located deployments\n *   (e.g., cedros-login and cedros-pay in the same Rust binary), inter-service\n *   auth uses JWT/JWKS and no API key is needed.\n * - Logging, Metrics, Security: always visible.\n */\nimport { useState, useEffect, useMemo } from 'react';\nimport { LoadingSpinner } from '../../shared/LoadingSpinner';\nimport { ErrorMessage } from '../../shared/ErrorMessage';\nimport { useSettingsAutosave } from '../../../hooks/useSettingsAutosave';\nimport { SettingsSection } from './settingsInputs';\nimport { AutosaveStatus } from './AutosaveStatus';\n\ntype ServerTab = 'integrations' | 'logging' | 'metrics' | 'security';\n\ninterface TabConfig {\n  id: ServerTab;\n  label: string;\n  /** Categories to pull settings from (defaults to ['server']) */\n  categories?: string[];\n  keys: string[];\n  /** When set, tab is only visible if this setting is 'true' */\n  requiredSetting?: string;\n}\n\nconst TABS: TabConfig[] = [\n  {\n    id: 'integrations',\n    label: 'Integrations',\n    keys: ['server_cedros_pay_api_key'],\n    requiredSetting: 'feature_cedros_pay',\n  },\n  {\n    id: 'logging',\n    label: 'Logging',\n    keys: ['server_log_level'],\n  },\n  {\n    id: 'metrics',\n    label: 'Metrics',\n    keys: ['server_metrics_api_key'],\n  },\n  {\n    id: 'security',\n    label: 'Security',\n    categories: ['security', 'features'],\n    keys: ['feature_mfa', 'security_cors_origins', 'security_session_timeout'],\n  },\n];\n\nexport interface ServerSettingsProps {\n  className?: string;\n}\n\nexport function ServerSettings({ className }: ServerSettingsProps) {\n  const {\n    settings,\n    edits,\n    isLoading,\n    autosaveStatus,\n    autosaveError,\n    error,\n    fetchSettings,\n    handleChange,\n    getEffectiveValue,\n  } = useSettingsAutosave();\n\n  // Filter tabs based on feature flags\n  const visibleTabs = useMemo(\n    () =>\n      TABS.filter((tab) => {\n        if (!tab.requiredSetting) return true;\n        return getEffectiveValue(tab.requiredSetting) === 'true';\n      }),\n    [getEffectiveValue]\n  );\n\n  // Default to first visible tab\n  const [activeTab, setActiveTab] = useState<ServerTab | null>(null);\n\n  // Set initial tab when tabs become available\n  useEffect(() => {\n    if (activeTab === null && visibleTabs.length > 0) {\n      setActiveTab(visibleTabs[0].id);\n    } else if (activeTab && !visibleTabs.some((t) => t.id === activeTab)) {\n      // Active tab was hidden (feature toggled off) â€” fall back\n      setActiveTab(visibleTabs[0]?.id ?? null);\n    }\n  }, [visibleTabs, activeTab]);\n\n  useEffect(() => {\n    fetchSettings();\n  }, [fetchSettings]);\n\n  // Get current tab config\n  const currentTab = visibleTabs.find((t) => t.id === activeTab);\n\n  // Collect settings from all categories for the current tab\n  const currentSettings = useMemo(() => {\n    if (!currentTab) return [];\n    const categories = currentTab.categories ?? ['server'];\n    const allSettings: (typeof settings)[string] = [];\n    for (const category of categories) {\n      const categorySettings = settings[category] ?? [];\n      allSettings.push(...categorySettings);\n    }\n    // Filter by keys and sort by keys order\n    return allSettings\n      .filter((s) => currentTab.keys.includes(s.key))\n      .sort((a, b) => currentTab.keys.indexOf(a.key) - currentTab.keys.indexOf(b.key));\n  }, [settings, currentTab]);\n\n  if (isLoading && Object.keys(settings).length === 0) {\n    return (\n      <div className={`cedros-system-settings cedros-system-settings-loading ${className ?? ''}`}>\n        <LoadingSpinner />\n        <span>Loading settings...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className={`cedros-system-settings ${className ?? ''}`}>\n        <ErrorMessage error={error.message} />\n      </div>\n    );\n  }\n\n  return (\n    <div className={`cedros-system-settings ${className ?? ''}`}>\n      <div className=\"cedros-settings-page-header\">\n        <div className=\"cedros-settings-page-header-content\">\n          <h2 className=\"cedros-settings-page-title\">Auth Server</h2>\n          <p className=\"cedros-settings-page-description\">\n            Server infrastructure settings. Some may be overridden by environment variables.\n          </p>\n        </div>\n        <AutosaveStatus status={autosaveStatus} error={autosaveError} />\n      </div>\n\n      {/* Tabs */}\n      <div className=\"cedros-admin-tabs cedros-admin-tabs--line\">\n        {visibleTabs.map((tab) => (\n          <button\n            key={tab.id}\n            type=\"button\"\n            className={`cedros-admin-tab ${activeTab === tab.id ? 'cedros-admin-tab-active' : ''}`}\n            onClick={() => setActiveTab(tab.id)}\n            aria-selected={activeTab === tab.id}\n            role=\"tab\"\n          >\n            {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Tab content */}\n      <div className=\"cedros-admin-tab-content\" role=\"tabpanel\">\n        {currentSettings.length === 0 ? (\n          <div className=\"cedros-system-settings-empty\">\n            <p>No settings found for {currentTab?.label ?? 'this section'}.</p>\n          </div>\n        ) : (\n          <SettingsSection settings={currentSettings} edits={edits} onChange={handleChange} />\n        )}\n      </div>\n    </div>\n  );\n}\n"],"names":["TABS","ServerSettings","className","settings","edits","isLoading","autosaveStatus","autosaveError","error","fetchSettings","handleChange","getEffectiveValue","useSettingsAutosave","visibleTabs","useMemo","tab","activeTab","setActiveTab","useState","useEffect","t","currentTab","currentSettings","categories","allSettings","category","categorySettings","s","a","b","jsx","LoadingSpinner","ErrorMessage","jsxs","AutosaveStatus","SettingsSection"],"mappings":"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"}