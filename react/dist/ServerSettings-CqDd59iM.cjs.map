{"version":3,"file":"ServerSettings-CqDd59iM.cjs","sources":["../src/components/admin/settings/ServerSettings.tsx"],"sourcesContent":["/**\n * Server settings page - infrastructure configuration with tabs\n *\n * Tab visibility:\n * - Integrations: only shown when `feature_cedros_pay` is enabled.\n *   This tab contains the Cedros Pay API Key, which is only needed when\n *   cedros-pay runs as a separate microservice. In co-located deployments\n *   (e.g., cedros-login and cedros-pay in the same Rust binary), inter-service\n *   auth uses JWT/JWKS and no API key is needed.\n * - Logging, Metrics, Security: always visible.\n */\nimport { useState, useEffect, useMemo } from 'react';\nimport { LoadingSpinner } from '../../shared/LoadingSpinner';\nimport { ErrorMessage } from '../../shared/ErrorMessage';\nimport { useSettingsAutosave } from '../../../hooks/useSettingsAutosave';\nimport { SettingsSection } from './settingsInputs';\nimport { AutosaveStatus } from './AutosaveStatus';\n\ntype ServerTab = 'integrations' | 'logging' | 'metrics' | 'security';\n\ninterface TabConfig {\n  id: ServerTab;\n  label: string;\n  /** Categories to pull settings from (defaults to ['server']) */\n  categories?: string[];\n  keys: string[];\n  /** When set, tab is only visible if this setting is 'true' */\n  requiredSetting?: string;\n}\n\nconst TABS: TabConfig[] = [\n  {\n    id: 'integrations',\n    label: 'Integrations',\n    keys: ['server_cedros_pay_api_key'],\n    requiredSetting: 'feature_cedros_pay',\n  },\n  {\n    id: 'logging',\n    label: 'Logging',\n    keys: ['server_log_level'],\n  },\n  {\n    id: 'metrics',\n    label: 'Metrics',\n    keys: ['server_metrics_api_key'],\n  },\n  {\n    id: 'security',\n    label: 'Security',\n    categories: ['security', 'features'],\n    keys: ['feature_mfa', 'security_cors_origins', 'security_session_timeout'],\n  },\n];\n\nexport interface ServerSettingsProps {\n  className?: string;\n}\n\nexport function ServerSettings({ className }: ServerSettingsProps) {\n  const {\n    settings,\n    edits,\n    isLoading,\n    autosaveStatus,\n    autosaveError,\n    error,\n    fetchSettings,\n    handleChange,\n    getEffectiveValue,\n  } = useSettingsAutosave();\n\n  // Filter tabs based on feature flags\n  const visibleTabs = useMemo(\n    () =>\n      TABS.filter((tab) => {\n        if (!tab.requiredSetting) return true;\n        return getEffectiveValue(tab.requiredSetting) === 'true';\n      }),\n    [getEffectiveValue]\n  );\n\n  // Default to first visible tab\n  const [activeTab, setActiveTab] = useState<ServerTab | null>(null);\n\n  // Set initial tab when tabs become available\n  useEffect(() => {\n    if (activeTab === null && visibleTabs.length > 0) {\n      setActiveTab(visibleTabs[0].id);\n    } else if (activeTab && !visibleTabs.some((t) => t.id === activeTab)) {\n      // Active tab was hidden (feature toggled off) â€” fall back\n      setActiveTab(visibleTabs[0]?.id ?? null);\n    }\n  }, [visibleTabs, activeTab]);\n\n  useEffect(() => {\n    fetchSettings();\n  }, [fetchSettings]);\n\n  // Get current tab config\n  const currentTab = visibleTabs.find((t) => t.id === activeTab);\n\n  // Collect settings from all categories for the current tab\n  const currentSettings = useMemo(() => {\n    if (!currentTab) return [];\n    const categories = currentTab.categories ?? ['server'];\n    const allSettings: (typeof settings)[string] = [];\n    for (const category of categories) {\n      const categorySettings = settings[category] ?? [];\n      allSettings.push(...categorySettings);\n    }\n    // Filter by keys and sort by keys order\n    return allSettings\n      .filter((s) => currentTab.keys.includes(s.key))\n      .sort((a, b) => currentTab.keys.indexOf(a.key) - currentTab.keys.indexOf(b.key));\n  }, [settings, currentTab]);\n\n  if (isLoading && Object.keys(settings).length === 0) {\n    return (\n      <div className={`cedros-system-settings cedros-system-settings-loading ${className ?? ''}`}>\n        <LoadingSpinner />\n        <span>Loading settings...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className={`cedros-system-settings ${className ?? ''}`}>\n        <ErrorMessage error={error.message} />\n      </div>\n    );\n  }\n\n  return (\n    <div className={`cedros-system-settings ${className ?? ''}`}>\n      <div className=\"cedros-settings-page-header\">\n        <div className=\"cedros-settings-page-header-content\">\n          <h2 className=\"cedros-settings-page-title\">Auth Server</h2>\n          <p className=\"cedros-settings-page-description\">\n            Server infrastructure settings. Some may be overridden by environment variables.\n          </p>\n        </div>\n        <AutosaveStatus status={autosaveStatus} error={autosaveError} />\n      </div>\n\n      {/* Tabs */}\n      <div className=\"cedros-admin-tabs cedros-admin-tabs--line\">\n        {visibleTabs.map((tab) => (\n          <button\n            key={tab.id}\n            type=\"button\"\n            className={`cedros-admin-tab ${activeTab === tab.id ? 'cedros-admin-tab-active' : ''}`}\n            onClick={() => setActiveTab(tab.id)}\n            aria-selected={activeTab === tab.id}\n            role=\"tab\"\n          >\n            {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Tab content */}\n      <div className=\"cedros-admin-tab-content\" role=\"tabpanel\">\n        {currentSettings.length === 0 ? (\n          <div className=\"cedros-system-settings-empty\">\n            <p>No settings found for {currentTab?.label ?? 'this section'}.</p>\n          </div>\n        ) : (\n          <SettingsSection settings={currentSettings} edits={edits} onChange={handleChange} />\n        )}\n      </div>\n    </div>\n  );\n}\n"],"names":["TABS","ServerSettings","className","settings","edits","isLoading","autosaveStatus","autosaveError","error","fetchSettings","handleChange","getEffectiveValue","useSettingsAutosave","visibleTabs","useMemo","tab","activeTab","setActiveTab","useState","useEffect","t","currentTab","currentSettings","categories","allSettings","category","categorySettings","s","a","b","jsx","LoadingSpinner","ErrorMessage","jsxs","AutosaveStatus","SettingsSection"],"mappings":"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"}